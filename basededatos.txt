-- TABLA PARA PLANES
CREATE TABLE Plan(
    IdPlan BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    TipoPlan VARCHAR(50) NOT NULL,
    Caracteristicas TEXT NOT NULL,
    Precio DECIMAL(10, 2) NOT NULL
) ENGINE=InnoDB;

-- TABLA DE USUARIOS
CREATE TABLE Usuario(
    IdUsuario BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    Nombre VARCHAR(50) NOT NULL,
    Apellido VARCHAR(50),
    Correo VARCHAR(100) UNIQUE NOT NULL,
    FechaRegistro DATETIME DEFAULT CURRENT_TIMESTAMP,
    IdPlan BIGINT UNSIGNED NOT NULL,
    FOREIGN KEY (IdPlan) REFERENCES Plan(IdPlan) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA PARA AUTENTICACIÓN DE INICIO DE SESIÓN
CREATE TABLE Login(
    IdLogin BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdUsuario BIGINT UNSIGNED NOT NULL UNIQUE,
    ContrasenaHash VARCHAR(255) NOT NULL,
    UltimoAcceso DATETIME,
    FOREIGN KEY (IdUsuario) REFERENCES Usuario(IdUsuario) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE PERFILES
CREATE TABLE Perfil(
    IdPerfil BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdUsuario BIGINT UNSIGNED NOT NULL,
    Nombre VARCHAR(50) NOT NULL,
    ApellidoPaterno VARCHAR(50),
    ApellidoMaterno VARCHAR(50),
    FechaNacimiento DATE,
    Telefono VARCHAR(15),
    FOREIGN KEY (IdUsuario) REFERENCES Usuario(IdUsuario) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE CATEGORÍAS
CREATE TABLE Categoria(
    IdCategoria BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    Nombre VARCHAR(50) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- TABLA DE CONTENIDO
CREATE TABLE Contenido(
    IdContenido BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdCategoria BIGINT UNSIGNED NOT NULL,
    Titulo VARCHAR(100) NOT NULL,
    Descripcion TEXT,
    Anio YEAR,
    FOREIGN KEY (IdCategoria) REFERENCES Categoria(IdCategoria) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE EPISODIOS
CREATE TABLE Episodio(
    IdEpisodio BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdContenido BIGINT UNSIGNED NOT NULL,
    Titulo VARCHAR(100) NOT NULL,
    Duracion TIME NOT NULL,
    FOREIGN KEY (IdContenido) REFERENCES Contenido(IdContenido) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE VISUALIZACIÓN (M:N ENTRE PERFIL Y CONTENIDO)
CREATE TABLE Visualizacion(
    IdVisualizacion BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdPerfil BIGINT UNSIGNED NOT NULL,
    IdContenido BIGINT UNSIGNED NOT NULL,
    FechaVisualizacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    TiempoVisto TIME,
    FOREIGN KEY (IdPerfil) REFERENCES Perfil(IdPerfil) ON DELETE CASCADE,
    FOREIGN KEY (IdContenido) REFERENCES Contenido(IdContenido) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE CALIFICACIONES
CREATE TABLE Calificacion(
    IdCalificacion BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdPerfil BIGINT UNSIGNED NOT NULL,
    IdContenido BIGINT UNSIGNED NOT NULL,
    Puntuacion TINYINT CHECK (Puntuacion BETWEEN 1 AND 5),
    FOREIGN KEY (IdPerfil) REFERENCES Perfil(IdPerfil) ON DELETE CASCADE,
    FOREIGN KEY (IdContenido) REFERENCES Contenido(IdContenido) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE DISPOSITIVOS
CREATE TABLE Dispositivo(
    IdDispositivo BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdPerfil BIGINT UNSIGNED NOT NULL,
    TipoDispositivo VARCHAR(50) NOT NULL,
    FechaAcceso DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (IdPerfil) REFERENCES Perfil(IdPerfil) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLA DE HISTORIAL DE PAGOS
CREATE TABLE HistorialPago(
    IdHistorialPago BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    IdUsuario BIGINT UNSIGNED NOT NULL,
    Fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    Monto DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (IdUsuario) REFERENCES Usuario(IdUsuario) ON DELETE CASCADE
) ENGINE=InnoDB;
